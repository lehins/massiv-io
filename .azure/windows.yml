jobs:
- job: ${{ parameters.name }}
  timeoutInMinutes: 120
  variables:
    STACK_ROOT: "c:\\s"
    STACK_WORK: ".w"
  pool:
    vmImage: ${{ parameters.vmImage }}
  strategy:
    matrix:
      lts-12.26:
        RESOLVER: "lts-12.26"
        STACK_YAML: "stack-extra-deps.yaml"
      lts-13.30:
        RESOLVER: "lts-13.30"
        STACK_YAML: "stack-extra-deps.yaml"
      lts-14.27:
        RESOLVER: "lts-14.27"
        STACK_YAML: "stack-extra-deps.yaml"
      lts-15:
        RESOLVER: "lts-15"
      nightly:
        RESOLVER: "nightly"
    maxParallel: 5
  steps:
  - displayName: Cache ~/.stack
    task: Cache@2
    inputs:
      key: '"$(Agent.OS)" | $(Build.SourceBranch) | $(RESOLVER) | .stack'
      path: "$(STACK_ROOT)"
      restoreKeys: '"$(Agent.OS)" | refs/heads/master | $(RESOLVER) | .stack'
  - displayName: Cache .stack-work
    task: Cache@2
    inputs:
      key: '"$(Agent.OS)" | $(Build.SourceBranch) | $(RESOLVER) | .stack-work'
      path: "$(STACK_WORK)"
      restoreKeys: '"$(Agent.OS)" | refs/heads/master | $(RESOLVER) | .stack-work'
  - displayName: Download tools
    bash: |
      # Install stack
      curl -sSkL https://www.stackage.org/stack/windows-x86_64 -o stack.zip
      7z x stack.zip stack.exe -aoa
      # Script for restoring source files modification time from commit to avoid recompilation.
      curl -sSkL https://gist.githubusercontent.com/lehins/fd36a8cc8bf853173437b17f6b6426ad/raw/d9ddb32cac2f0dc6800be4fa54d450f0dcda6c60/git-modtime.hs -o git-modtime.hs
  - displayName: Test on ${{parameters.os}}'
    bash: |
      # stack script --resolver ${RESOLVER} git-modtime.hs
      stack "${ARGS}" test massiv-io:tests "${BUILD_ARGS}"
      stack "${ARGS}" test massiv-io:doctests "${BUILD_ARGS}"
    env:
      ARGS: "--resolver $(RESOLVER)"
      BUILD_ARGS: "-j 2 --no-terminal --bench --no-run-benchmarks --haddock --no-haddock-deps"
